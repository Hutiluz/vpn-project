# VPN-palvelin WireGuardin avulla
### Projektin esittely
- Miniprojektinani tein VPN-palvelimen WireGuardin avulla. Projektia varten luon kolme virtuaalikonetta: MasterServerin, VpnServerin ja ClientServerin. Master-palvelin toimii luonnollisesti toimialueen salt-masterina, kun taas vpn -ja client-palvelimet ovat salt-minionin roolissa. Ideana on reitittää client-palvelin vpn-palvelimen kautta, mutta master-palvelimen hallinnoimana.
  
### Sisällysluettelo
[1. Master-palvelimen pystytys ja Salt-masterin asennus](https://github.com/Hutiluz/vpn-project/blob/main/Projektin%20etusivu%20ja%20vaiheet.md#1-master-palvelimen-pystytys-ja-salt-masterin-asennus) <br>
[2. Vpn-palvelimen pystytys ja Salt-minionin asennus](https://github.com/Hutiluz/vpn-project/blob/main/Projektin%20etusivu%20ja%20vaiheet.md#2-vpn-palvelimen-pystytys-ja-salt-minionin-asennus) <br>
[3. Client-palvelimen pystytys ja Salt-minionin asennus](https://github.com/Hutiluz/vpn-project/blob/main/Projektin%20etusivu%20ja%20vaiheet.md#3-client-palvelimen-pystytys-salt-minionin-asennus-ja-p%C3%A4ivitysten-automaattinen-asennus) <br>
[4. Salt-masterin automatisoitu asennus ja Vagrantfilen hienosäätö](https://github.com/Hutiluz/vpn-project/blob/main/Projektin%20etusivu%20ja%20vaiheet.md#4-salt-masterin-automatisoitu-asennus-ja-vagrantfilen-hienos%C3%A4%C3%A4t%C3%B6) <br>
[5. Palvelinten linkitys](https://github.com/Hutiluz/vpn-project/blob/main/Projektin%20etusivu%20ja%20vaiheet.md#5-palvelinten-linkitys) <br>
[6. WireGuardin asennus ja konfigurointi](https://github.com/Hutiluz/vpn-project/blob/main/Projektin%20etusivu%20ja%20vaiheet.md#6-wireguardin-asennus-ja-konfigurointi) <br>
[Lähteet](https://github.com/Hutiluz/vpn-project/blob/main/Projektin%20etusivu%20ja%20vaiheet.md#l%C3%A4hteet)<br>
  
### 1. Master-palvelimen pystytys ja Salt-masterin asennus
- Ensin loin projektille uuden kansion ja siirryin sinne komennolla `mkdir vpn-project && cd vpn-project`. Tämän jälkeen latasin focal64 komennolla `vagrant box add ubuntu/focal64` ja alustin sen ajamalla komennon `vagrant init ubuntu/focal64`. Kun virtuaalikone oli luotu, niin siirryin muokkaamaan Vagrantfile-tiedostoa komennolla `notepad Vagrantfile`.
 ![Näyttökuva (1)](https://github.com/user-attachments/assets/781d1a51-6e0c-4e3e-8dc8-609a984b848f)
- Aiemmissa harjoituksissa olen käyttänyt kurssimateriaaleissa annettuja valmiita koodinpätkiä, mutta projektia varten halusin kokeilla kirjoittaa mahdollisimman paljon itse. En ole kuitenkaan aiemmin kirjoittanut Rubylla enkä ole kovin kokenut koodari, joten otin hieman mallia [Teron materiaaleista](https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/). Päätin aloittaa luomalla ensin pelkästään master-palvelimen ja lähteä siitä sitten laajentamaan projektia vaiheittain. Kuvakaappauksessa olevassa koodissa määrittelen master-palvelimelle nimen, käytettävän käyttöjärjestelmän ja ip-osoitteen. Tämän jälkeen käynnistin virtuaalikoneen komennolla `vagrant up` ja yhdistin sille komennolla `vagrant ssh MasterServer`. 
 ![Näyttökuva (2)](https://github.com/user-attachments/assets/c82d6afb-9634-4cb9-899f-be50aa8884bf)
- Kirjauduttuani palvelimelle hain päivitykset komennolla `sudo apt-get update` ja yritin asentaa salt-masterin komennolla `sudo apt-get -y install salt-master`. Komento ei kuitenkaan toiminut, koska olin unohtanut että Saltin asennukseen tarvitsee repot curlien kautta. Loin avaimille oman hakemiston komennolla `sudo mkdir -p /etc/apt/keyrings`, latasin avaimet [täältä](https://docs.saltproject.io/salt/install-guide/en/latest/topics/install-by-operating-system/linux-deb.html), hain paketit uudestaan komennolla `sudo apt update` ja asensin salt-masterin komennolla `sudo apt-get install salt-master`. Lopuksi poistuin master-palvelimelta `exit` komennolla.

  ![Näyttökuva (3)](https://github.com/user-attachments/assets/91e72cc2-b25e-45fb-95b1-c61f0b5c7326)
  ![Näyttökuva (4)](https://github.com/user-attachments/assets/294744e1-5024-4d06-9c80-d17dafccbd37)
  ![Näyttökuva (5)](https://github.com/user-attachments/assets/7adbd5b6-5f96-4a4f-8c04-58908ced8d94)

### 2. Vpn-palvelimen pystytys ja Salt-minionin asennus
- Kirjauduttuani ulos master-palvelimelta siirryin takaisin muokkaamaan Vagrantfilea komennolla `notepad Vagrantfile`. Master-palvelinta varten luotu koodinpätkä oli toimiva, joten kopioin sen sellaisenaan vpn-palvelinta varten muuttaen palvelimen nimen ja ip-osoitteen. Nyt kun olin asentanut Salt-masterin manuaalisesti, niin halusin kokeilla luoda Vagrantfileen skriptin, joka automaattisesti asentaa Salt-minionin. Katsoin tähän mallia [täältä](https://developer.hashicorp.com/vagrant/docs/provisioning/shell#inline-scripts) ja tein sen pohjalta kuvakaappauksen mukaisen skriptin.
  ![Näyttökuva (6)](https://github.com/user-attachments/assets/4d4975ce-43a2-486e-84bb-169904e27107)
- Käynnistin koneet uudelleen komennolla `vagrant up` ja master-palvelin käynnistyy normaalisti, mutta vpn-palvelin heittää timeouttia. Kokeilin kirjautua vpn-palvelimelle komennolla `vagrant ssh VpnServer` ja tarkastin salt-minionin tilan komennolla `systemctl status salt-minion`. Kuten kuvakaappauksesta näkyy, pääsin kirjautumaan normaalisti sisälle, mutta laitteen nimi on väärin eikä salt-minion ollut asentunut. Kirjaudun ulos koneelta `exit` komennolla ja ajoin uudelleen minion_scriptin komennolla `vagrant provision VpnServer`.
  ![Näyttökuva (7)](https://github.com/user-attachments/assets/534ae1a1-7bc6-4565-8e71-3e4e0957686e)
  ![Näyttökuva (8)](https://github.com/user-attachments/assets/0514fe47-3c07-4031-869d-9f1a3b405cfc)
- Kirjauduin uudelleen palvelimelle ja tarkistin salt-minionin tilan komennolla `systemctl status salt-minion`. Tällä kertaa salt-minion oli asentunut, mutta palvelimen nimi oli edelleen väärin. Muutin sen manuaalisesti komennolla `sudo hostnamectl set-hostname vpn` ja käynnistin koneen uudelleen. Kun yhdistin takaisin koneelle, niin palvelimen nimi oli myös oikein. Lopuksi poistuin palvelimelta komennolla `exit`.
  ![Näyttökuva (10)](https://github.com/user-attachments/assets/b97b0ab0-6633-4a48-b8f2-68791a467df5)
  ![Näyttökuva (11)](https://github.com/user-attachments/assets/ed48c5e7-55eb-43f1-968f-7b953717e571)
  
### 3. Client-palvelimen pystytys, Salt-minionin asennus ja päivitysten automaattinen asennus
- Vagrantfilessa sekä koneen luonti että minion_script selkeästi toimivat, mutta vpn-palvelimen kanssa prosessi ei ollut täysin automatisoitu kuten toivoin. Halusin varmistaa koodin toimivuuden kopioimalla sen client-palvelimelle ja muuttamalla hostnamen ja ip-osoitteen. Alla olevassa kuvakaappauksessa näkyy muokattu Vagrantfile.
  ![Näyttökuva (12)](https://github.com/user-attachments/assets/7e0a580d-b55a-456b-a59a-f1db433aa613)
- Käynnistin koneet jälleen `vagrant up` komennolla, mutta tällä kertaa kaikki sujui hyvin eikä tullut timeouttia. Yhdistin client-palvelimelle komennolla `vagrant ssh ClientServer` ja tarkistin salt-minionin tilan komennolla `systemctl status salt-minion`. Salt-minion oli asentunut kerralla oikein ja palvelimen nimikin oli oikein. Kirjauduinkin ulos palvelimelta ja siirryin takaisin Vagrantfileen tekemään muutamia hienosäätöjä.
  ![Näyttökuva (13)](https://github.com/user-attachments/assets/618e8621-b5e5-4540-a73e-74d59535b093)
- Nyt kun Vagrantfilen koodit ja skriptit on todettu toimiviksi halusin lisätä vielä uuden update-skriptin, joka hakee ja asentaa päivitykset automaattisesti. Otin mallia aiemmasta minion_scriptistä ja lisäsin jokaisen virtuaalikoneen ajamaan sen käynnistyksen yhteydessä. Alla on kuvakaappaus päivitetystä Vagrantfilesta.
  ![Näyttökuva (14)](https://github.com/user-attachments/assets/16c6c888-e478-4c92-a8d4-2ac9fd270786)
- Koska koneet ovat jo päällä, niin en voi testata update-skriptin toimivuutta `vagrant up` komentoa tuhoamatta niitä. Sen sijaan testasin sitä käyttämällä `vagrant provision [palvelimen nimi]`-komentoa. Ajoin komennot yksitellen kaikille kolmelle palvelimelle ja vaikka skriptien ajot onnistuivat, niin tein muutamia huomioita.
    - Minion_script ajetaan, vaikka salt-minion olisi jo asennettu. Se ei tässä vaiheessa vielä periaatteessa ei haittaa, koska ylimääräisiä muutoksia ei tapahdu, mutta se kuitenkin voi hidastaa turhaan palvelinten käynnistymistä.
    - Update-skripti toimii, mutta se ei aina asenna kaikkia päivityksiä, vaikka pitäisi.
    - Salt-master ei aina käynnistynyt automaattisesti, vaan se piti käydä erikseen potkaisemassa käyntiin palvelimella.

### 4. Salt-masterin automatisoitu asennus ja Vagrantfilen hienosäätö
- Aloitin helpoimmasta ongelmasta eli salt-masterin automaattisesta käynnistyksestä. Halusin tehdä myös sen asennuksesta automatisoidun, joten kopioin minion_scriptin ja tein siitä uuden master_scriptin, jonka lisäsin MasterServerin provisioneihin. Varmistin vielä saltin automaattisen käynnistyksen lisäämällä loppuun `sudo systemctl start salt-master`. Minion-palvelimilla ei ollut vastaavaa ongelmaa saltin käynnistyksessä, mutta lisäsin minion_scriptinkin loppuun `sudo systemctl start salt-mainion` ettei se tule myöhemmin kummittelemaan.
- Siirryin sen jälkeen korjaamaan update-skriptiä. Kokeilin ensin antaa skriptille root-oikeudet lisäämällä `sudo` komentojen eteen, mutta se ei auttanut. Löysin AskUbuntusta [keskustelun](https://askubuntu.com/questions/449032/29-packages-can-be-updated-how), jossa toisella käyttäjällä oli vastaava ongelma ja siihen oli ehdotettu `dist-upgrade` käyttöä. Tämä korjasi ongelman ja kaikki päivitykset asentuivat, mutta palvelimet tarvitsivat uudelleenkäynnistystä. Yritin lisätä update-skriptin loppuun `sudo reboot`, mutta se vain keskeytti skriptin eikä jatkunut automaattisesti boottauksen jälkeen. En löytänyt tähän äkkiseltään toimivaa ratkaisua, mutta koska palvelimet toimivat ongelmitta ilman uudelleenkäynnistystä, niin en pidä tätä toiminnan kannalta akuuttina ongelmana. Alla kuvakaappaus skriptistä tähän mennessä.
  ![Näyttökuva (15)](https://github.com/user-attachments/assets/66340034-418a-46e4-8dd6-a64abe81874d)
- Tämän jälkeen siirryin luomaan master_scriptiin ja minion_scriptiin if-else silmukkaa, joka asentaa saltin vain, jos sitä ei ole valmiiksi asennettu. Tämä ei ole varsinaisesti haastava, sillä tiedän mitä pitää tehdä, mutta en ole kovin kokenut shell skriptaaja, joten tämä vaati hieman perehtymistä. Löysin onneksi StackOverflown [keskustelusta](https://stackoverflow.com/questions/1298066/how-can-i-check-if-a-package-is-installed-and-install-it-if-not) tarkoitukseen sopivan koodinpätkän ja sovelsin sitä omiin skripteihini. Kokeilin sen toimivuutta Master-palvelimella komennolla `vagrant provision MasterServer` ja se toimi hyvin. Alla kuvakaappaukset skripteistä tähän mennessä ja provision-komennon tulosteesta.
  ![Näyttökuva (16)](https://github.com/user-attachments/assets/01f5c380-076a-43e9-826f-5f0236f2d954)
  ![Näyttökuva (17)](https://github.com/user-attachments/assets/e9211929-aa43-441d-8163-b14823071bb6)

### 5. Palvelinten linkitys
- Kun Vagrantfilen automaatiot oli hiottu, niin siirryin takaisin master-slave rakenteen luomiseen. Aloitin kirjautumalla vpn-palvelimelle komennolla `vagrant ssh ClientServer` ja katsomalla mallia [täältä](https://docs.saltproject.io/salt/install-guide/en/latest/topics/configure-master-minion.html#connecting-to-the-salt-master) ajoin komennon `sudo nano /etc/salt/minion.d/master.conf`. Tämän jälkeen kopioin Notepadista master-palvelimelle asetetun ip-osoitteen ja lisäsin sen tiedostoon. Tämän jälkeen ajoin komennon `sudo systemctl restart salt-minion` ja poistuin vpn-palvelimelta. Kun vpn-palvelin oli soittanut kotiin hyppäsin master-palvelimelle hyväksymään avaimen ajamalla ensin komennon `sudo salt-key -L` ja hyväksymällä vpn-palvelimen avaimen komennolla `sudo salt-key -a vpn`
  
  ![Näyttökuva (18)](https://github.com/user-attachments/assets/94b16110-668e-4199-9d5a-d0ab2df86b71)
  
  ![Näyttökuva (19)](https://github.com/user-attachments/assets/eb6efee0-6fcd-451a-804d-b9a043ff439b)

  ![Näyttökuva (20)](https://github.com/user-attachments/assets/8717dda6-c01e-44fa-9177-5ce931c71e2e)
  
- Nyt kun palvelimet oli onnistuneesti liitetty manuaalisesti, niin halusin automatisoida prosessin Vagrantfileen. Pallottelin jonkin aikaa, että lisäänkö soiton kotiin minion_scriptin loppuun vai teenkö sille oman call_home skriptin. Tulin lopulta siihen lopputulokseen, että on helpointa laittaa se minion_scriptin loppuun, mutta lisätä se if-loopin ulkopuolelle. Tällöin avaimen voi lähettää tarvittaessa uudelleen ajamalla `vagrant provision VpnServer` tai `vagrant provision ClientServer` komennon, mutta sitä varten ei tarvitse luoda uutta skriptiä. Alla kuvakaappaus päivitetystä skriptistä, jossa master-palvelimen ip-osoite lisätään master.conf tiedostoon sudo oikeuksin ja salt-minion potkaistaan uudelleen käyntiin, jotta avain lähtee liikkeelle.
  ![Näyttökuva (21)](https://github.com/user-attachments/assets/701600f5-24e3-40f2-a14a-00d4ab0156ad)
- Puhelun vastaamisessa päädyin samanlaiseen ratkaisuun, kuin minion_scriptinkin kanssa eli lisäsin master_scriptin loppuun if-silmukan ulkopuolelle muutaman rivin koodia, jotka käyvät hyväksymässä lähetetyt avaimet. Tätä kohtaa en kuitenkaan saanut täysin automatisoitua, sillä skripti etenee järjestyksessä ylhäältä alas. Jos master-palvelin luodaan ensin, niin skriptillä ei ole vielä hyväksyttäviä avaimia, koska client-palvelinta tai vpn-palvelinta ei ole vielä luotu. Jos taas siirrän master-palvelimen järjestyksessä viimeiseksi, niin avaimet eivät tule perille, koska niille annetussa ip-osoitteessa ei ole vielä mitään. En myöskään keksinyt järkevää tapaa, jolla olisin voinut suorittaa avainten hyväksymisen sen jälkeen, kun virtuaalikoneet oli luotu, sillä provisionien tulee olla define-lohkon sisällä. Tyydyinkin siis siihen, että koneiden käynnistyessä `vagrant up` komennolla ajan uudelleen `vagrant provision MasterServer`, jotta Vagrant ajaa uudelleen skriptin, joka hyväksyy avaimet. Eli ensimmäisellä kerralla koodi ei tee vielä mitään, mutta toistettaessa uudestaan se hyväksyy avaimet. Kun avaimet on hyväksytty, niin vaikka se ajettaisiin uudelleen niin mitään ei tapahdu, koska ei ole enää hyväksyttäviä avaimia. Alla kuvakaappaus päivitetystä master_scriptistä, joka hyväksyy avaimet nimeltä vpn ja client.
  ![Näyttökuva (22)](https://github.com/user-attachments/assets/3078fb2b-a02c-4703-acff-a42955c81bd5)
- Lopuksi testasin, että kaikki varmasti toimii tuhoamalla koneet `vagrant destroy` komennolla ja ajamalla uudelleen `vagrant up`. Periaatteessa olisin vain voinut ajaa esim. `vagrant provision ClientServer` ja `vagrant provision MasterServer` komennot, mutta koodiin oli tullut niin paljon kerroksia, että halusin varmistaa kaiken toimivan oikein. Kaikki onneksi toimi kuten pitikin, joten pääsin jatkamaan WireGuardin pariin.
  
  ![Näyttökuva (23)](https://github.com/user-attachments/assets/582c3904-7d4c-4d3c-90e2-24d82c0382cd)
  ![Näyttökuva (24)](https://github.com/user-attachments/assets/ecabd52f-6c3f-412c-b059-d6b7e4d9f1a1)

### 6. WireGuardin asennus ja konfigurointi
- Aloitin WireGuardin asennuksen kirjautumalla ensin master-palvelimelle komennolla `vagrant ssh MasterServer` ja varmistamalla yhteyden minionien kanssa pingaamalla ne komennolla `sudo salt '*' test.ping`. Kummatkin palvelimet vastasivat, joten pääsin jatkamaan eteenpäin. Loin WireGuardille oman hakemiston komennolla `sudo mkdir -p /srv/salt/wireguard`, jonka jälkeen loin sille init.sls tiedoston komennolla `sudo nano /srv/salt/wireguard/init.sls`. Halusin jälleen lähteä aluksi aika yksinkertaisesta liikkeelle, joten lisäsin init-tiedostoon pelkästään WireGuardin pkg.installed ja ajoin sen minioneille komennolla `sudo salt '*' state.apply wireguard`. Komento toimi ja WireGuard asentui kummallekin minionille. Varmistin idempotentin ajamalla komennon uudelleen, mikä myös toimi odotetusti.
  ![Näyttökuva (25)](https://github.com/user-attachments/assets/85fe958e-f600-4ccb-b0f8-31cd3c0e1e73)
  
  ![Näyttökuva (26)](https://github.com/user-attachments/assets/9f8044b2-4bdb-4a45-a115-f4fe56ae82a5)
  
  ![Näyttökuva (27)](https://github.com/user-attachments/assets/7da941ce-81f0-4dcd-bdde-4404f36799b5)
- Tästä eteenpäin homma alkoi muuttua haastavammaksi, sillä seurasin WireGuardin asennus [tutoriaalia](https://www.netmaker.io/resources/wireguard-vpn) ja seuraavassa vaiheessa tuli luoda erilaiset avaimet client -ja vpn-palvelimille. Tämä ei tietenkään onnistunut yhdellä init.sls tiedostolla, sillä se luo samat tiedostot kummallekin minionille. Tämän vuoksi jouduin luomaan kaksi init-tiedostoa, jotka ajan erikseen omille minioneille. Muutin alkuperäisen init-tiedoston nimeksi vpn_init.sls ja loin toisen tiedoston clientille komennolla `sudo nano /srv/salt/wireguard/client_init.sls`.
  ![Näyttökuva (28)](https://github.com/user-attachments/assets/c435c08a-1e25-4fea-89e6-5a2d65c8bc52)
- Tämän jälkeen tein config-tiedostoille ja avaimille oman polun komennolla `sudo mkdir -p /srv/salt/wireguard/files` ja siirryin sinne komennolla `cd /srv/salt/wireguard/files/`. Seuraavaksi yritin luoda palvelimille avainparit ajamalla komennon `sudo wg genkey | sudo tee vpn_private.key | wg pubkey | sudo tee vpn_public.key`. Nimi on eri kuin ohjeistuksessa, koska sama komento tulisi ajaa erikseen vpn-palvelimella ja client-palvelimella, jolloin generoituja avaimia olisi yhteensä neljä. Haluan tehdä tämän kuitenkin master-palvelimelta käsin, joten päätin antaa avaimilleni nimiksi vpn_private.key ja vpn_public.key. Komento ei kuitenkaan toiminut, koska en ollut asentanut WireGuardia master-palvelimelle. Asensin sen nopeasti hakemalla ensin päivitykset komennolla `sudo apt update` ja sitten asentamalla wireguardin komennolla `sudo apt install wireguard -y`
  ![Näyttökuva (29)](https://github.com/user-attachments/assets/5faf3d1c-06a6-4b78-bc3b-9dc0432b18de)
- Kun WireGuard oli asentunut, niin kokeilin uudestaan luoda palvelimille avainparit komennoilla `sudo wg genkey | sudo tee vpn_private.key | wg pubkey | sudo tee vpn_public.key` ja `sudo wg genkey | sudo tee client_private.key | wg pubkey | sudo tee client_public.key`. Tällä kertaa komento toimi ja avaimet luotiin. Tämän jälkeen loin config-tiedostot komennoilla `sudo nano vpn_wg0.conf` ja `sudo nano client_wg0.conf`, kopioin ohjeistuksessa olleet config-tiedoston pohjat ja liitin avaimet siihen.
- ![Näyttökuva (30)](https://github.com/user-attachments/assets/9ff87780-3a0f-4468-9c66-9fe150da69da)


## Lähteet:
- Karvinen 2025: https://terokarvinen.com/palvelinten-hallinta/#laksyt. Luettu 4.5.2025.
- Karvinen 2021: https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/. Luettu 5.5.2025.
- VMware, Inc 2025: https://docs.saltproject.io/salt/install-guide/en/latest/topics/install-by-operating-system/linux-deb.html. Luettu 5.5.2025.
- HashiCopr Developer s.a: https://developer.hashicorp.com/vagrant/docs/provisioning/shell#inline-scripts. Luettu 5.5.2025.
- AskUbuntu 2014: https://askubuntu.com/questions/449032/29-packages-can-be-updated-how. Luettu 5.5.2025.
- It's Foss 2023: https://itsfoss.com/apt-get-upgrade-vs-dist-upgrade/. Luettu 5.5.2025.
- StackOverflow 2009: https://stackoverflow.com/questions/1298066/how-can-i-check-if-a-package-is-installed-and-install-it-if-not. Luettu 5.5.2025.
- VMware, Inc 2022: https://docs.saltproject.io/salt/install-guide/en/latest/topics/configure-master-minion.html#connecting-to-the-salt-master. Luettu 5.5.2025.
- AskUbuntu 2014: https://askubuntu.com/questions/408340/is-there-any-significance-to-using-tee. Luettu 5.5.2025.
- Netmaker 2024: https://www.netmaker.io/resources/wireguard-vpn. Luettu 6.5.2025.
